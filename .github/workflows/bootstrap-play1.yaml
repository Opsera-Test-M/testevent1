# =============================================================================
# ğŸ¦ OPSERA DevOps Copilot - Bootstrap Infrastructure Workflow
# Skill Version: 4.0.0
# App: play1 | Cloud: AWS | Tenant: opsera
# =============================================================================
name: "ğŸš€ Bootstrap - play1"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: string
      region:
        description: 'AWS Region'
        required: true
        default: 'us-west-2'
        type: string

env:
  APP_NAME: play1
  TENANT: opsera
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  DOMAIN: agent.opsera.dev
  OPSERA_FOLDER: .opsera-play1

concurrency:
  group: bootstrap-play1-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # =========================================================================
  # Job 1: Verify Prerequisites
  # =========================================================================
  verify-prerequisites:
    name: "ğŸ” Verify Prerequisites"
    runs-on: ubuntu-latest
    outputs:
      subdomain: ${{ steps.subdomain.outputs.value }}
      ecr_uri: ${{ steps.ecr.outputs.uri }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "id=${AWS_ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "âœ… AWS Account ID: ${AWS_ACCOUNT_ID}"

      - name: Generate Subdomain
        id: subdomain
        run: |
          SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}.${{ env.DOMAIN }}"
          echo "value=${SUBDOMAIN}" >> $GITHUB_OUTPUT
          echo "âœ… Subdomain: ${SUBDOMAIN}"

      - name: Create ECR Repository (if not exists)
        id: ecr
        run: |
          ECR_REPO="${{ env.TENANT }}/${{ env.APP_NAME }}"
          AWS_ACCOUNT_ID="${{ steps.account.outputs.id }}"
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${ECR_REPO}"
          
          if aws ecr describe-repositories --repository-names "${ECR_REPO}" 2>/dev/null; then
            echo "âœ… ECR repository exists: ${ECR_REPO}"
          else
            echo "ğŸ“ Creating ECR repository: ${ECR_REPO}"
            aws ecr create-repository \
              --repository-name "${ECR_REPO}" \
              --image-scanning-configuration scanOnPush=true \
              --tags Key=Tenant,Value=${{ env.TENANT }} Key=App,Value=${{ env.APP_NAME }}
          fi
          
          echo "uri=${ECR_URI}" >> $GITHUB_OUTPUT
          echo "âœ… ECR URI: ${ECR_URI}"

  # =========================================================================
  # Job 2: Update Manifests with Actual Values
  # =========================================================================
  update-manifests:
    name: "ğŸ“ Update Manifests"
    runs-on: ubuntu-latest
    needs: verify-prerequisites
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes
        run: git pull --rebase origin main

      - name: Get Repository URL
        id: repo
        run: |
          REPO_URL=$(git remote get-url origin)
          echo "url=${REPO_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Repository URL: ${REPO_URL}"

      - name: Update ArgoCD Application
        run: |
          MANIFEST="${{ env.OPSERA_FOLDER }}/argocd/application.yaml"
          
          # Update repository URL
          sed -i "s|PLACEHOLDER_REPO_URL|${{ steps.repo.outputs.url }}|g" "$MANIFEST"
          
          # Update application name
          sed -i "s|name: ${{ env.APP_NAME }}-.*|name: ${{ env.APP_NAME }}-${{ inputs.environment }}|" "$MANIFEST"
          
          # Update environment label
          sed -i "s|environment: .*|environment: ${{ inputs.environment }}|" "$MANIFEST"
          
          # Update source path
          sed -i "s|path: .*|path: ${{ env.OPSERA_FOLDER }}/k8s/overlays/${{ inputs.environment }}|" "$MANIFEST"
          
          # Update destination namespace
          sed -i "s|namespace: ${{ env.APP_NAME }}-.*|namespace: ${{ env.APP_NAME }}-${{ inputs.environment }}|" "$MANIFEST"
          
          echo "âœ… Updated ArgoCD application manifest"
          cat "$MANIFEST"

      - name: Update Kustomization with ECR URI
        run: |
          ECR_URI="${{ needs.verify-prerequisites.outputs.ecr_uri }}"
          
          # Update base kustomization
          sed -i "s|PLACEHOLDER_ECR_URI|${ECR_URI}|g" "${{ env.OPSERA_FOLDER }}/k8s/base/kustomization.yaml"
          
          # Update overlay kustomization
          sed -i "s|PLACEHOLDER_ECR_URI|${ECR_URI}|g" "${{ env.OPSERA_FOLDER }}/k8s/overlays/${{ inputs.environment }}/kustomization.yaml"
          
          echo "âœ… Updated kustomization files with ECR URI"

      - name: Update Ingress with Subdomain
        run: |
          SUBDOMAIN="${{ needs.verify-prerequisites.outputs.subdomain }}"
          
          # Update base ingress
          sed -i "s|PLACEHOLDER_SUBDOMAIN|${SUBDOMAIN}|g" "${{ env.OPSERA_FOLDER }}/k8s/base/ingress.yaml"
          
          # Update overlay ingress patch
          sed -i "s|PLACEHOLDER_SUBDOMAIN|${SUBDOMAIN}|g" "${{ env.OPSERA_FOLDER }}/k8s/overlays/${{ inputs.environment }}/patch-ingress.yaml"
          
          echo "âœ… Updated ingress with subdomain: ${SUBDOMAIN}"

      - name: Commit and Push Changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: bootstrap play1 ${{ inputs.environment }} manifests [skip ci]"
            git push origin main
          fi

  # =========================================================================
  # Job 3: Setup ArgoCD
  # =========================================================================
  setup-argocd:
    name: "ğŸ”§ Setup ArgoCD"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, update-manifests]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GH_PAT }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          kubectl cluster-info

      - name: Create ArgoCD Repository Secret
        run: |
          REPO_URL=$(git remote get-url origin)
          SECRET_NAME="repo-${{ env.APP_NAME }}"
          
          # Delete existing secret if exists
          kubectl delete secret "${SECRET_NAME}" -n argocd --ignore-not-found
          
          # Create new secret
          kubectl create secret generic "${SECRET_NAME}" \
            --namespace argocd \
            --from-literal=url="${REPO_URL}" \
            --from-literal=password="${{ secrets.GH_PAT }}" \
            --from-literal=username="git" \
            --from-literal=type="git"
          
          kubectl label secret "${SECRET_NAME}" -n argocd \
            argocd.argoproj.io/secret-type=repository
          
          echo "âœ… Created ArgoCD repository secret"

      - name: Apply ArgoCD Application
        run: |
          kubectl apply -f ${{ env.OPSERA_FOLDER }}/argocd/application.yaml
          echo "âœ… Applied ArgoCD application"

      - name: Verify ArgoCD Application
        run: |
          APP_NAME="${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          for i in {1..30}; do
            SYNC_STATUS=$(kubectl get application "${APP_NAME}" -n argocd \
              -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
            
            echo "[$i/30] Sync Status: ${SYNC_STATUS}"
            
            if [ "$SYNC_STATUS" = "Synced" ]; then
              echo "âœ… ArgoCD application synced successfully"
              break
            fi
            
            if [ "$SYNC_STATUS" = "Unknown" ]; then
              echo "âš ï¸ Sync status unknown - checking application..."
              kubectl describe application "${APP_NAME}" -n argocd | tail -20
            fi
            
            sleep 10
          done

  # =========================================================================
  # Job 4: Summary
  # =========================================================================
  summary:
    name: "ğŸ“Š Bootstrap Summary"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, update-manifests, setup-argocd]
    if: always()
    steps:
      - name: Display Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ¦ OPSERA - Bootstrap Complete                                                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                                  â•‘"
          echo "â•‘  App:         play1                                                              â•‘"
          echo "â•‘  Environment: ${{ inputs.environment }}                                          â•‘"
          echo "â•‘  Tenant:      opsera                                                             â•‘"
          echo "â•‘  Region:      ${{ env.AWS_REGION }}                                              â•‘"
          echo "â•‘                                                                                  â•‘"
          echo "â•‘  ECR URI:     ${{ needs.verify-prerequisites.outputs.ecr_uri }}                  â•‘"
          echo "â•‘  Subdomain:   ${{ needs.verify-prerequisites.outputs.subdomain }}                â•‘"
          echo "â•‘                                                                                  â•‘"
          echo "â•‘  Next Steps:                                                                     â•‘"
          echo "â•‘  1. Run CI/CD workflow: gh workflow run ci-cd-play1.yaml                         â•‘"
          echo "â•‘  2. Run HTTPS setup: gh workflow run setup-https-play1.yaml                      â•‘"
          echo "â•‘                                                                                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
