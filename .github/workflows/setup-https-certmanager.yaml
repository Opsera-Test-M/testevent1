name: "Setup HTTPS with cert-manager"

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name'
        required: true
        default: 'event-genie'
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: string
      tenant:
        description: 'Tenant name'
        required: true
        default: 'opsera'
        type: string

env:
  AWS_REGION: us-west-2
  APP_NAME: ${{ inputs.app_name }}
  ENVIRONMENT: ${{ inputs.environment }}
  TENANT: ${{ inputs.tenant }}
  SPOKE_CLUSTER: ${{ inputs.tenant }}-usw2-np
  DOMAIN: agent.opsera.dev
  NAMESPACE: ${{ inputs.app_name }}-${{ inputs.environment }}

jobs:
  setup-https:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Connect to Spoke Cluster
        run: |
          aws eks update-kubeconfig --name ${SPOKE_CLUSTER} --region ${AWS_REGION}

      - name: Verify cert-manager is installed
        run: |
          # Install kubectl locally (RULE 25)
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          KUBECTL="./kubectl"

          if $KUBECTL get namespace cert-manager 2>/dev/null; then
            echo "cert-manager namespace exists"

            # Check if cert-manager pods are running
            $KUBECTL get pods -n cert-manager

            # Check if ClusterIssuer exists
            if $KUBECTL get clusterissuer letsencrypt-prod 2>/dev/null; then
              echo "ClusterIssuer letsencrypt-prod exists"
            else
              echo "WARNING: ClusterIssuer letsencrypt-prod not found"
              echo "cert-manager may not be fully configured"
            fi
          else
            echo "ERROR: cert-manager not installed on cluster"
            echo "Please install cert-manager before running this workflow"
            exit 1
          fi

      - name: Verify Ingress exists
        run: |
          # Install kubectl locally (RULE 25)
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          KUBECTL="./kubectl"

          SUBDOMAIN="${TENANT}-${APP_NAME}-${ENVIRONMENT}.${DOMAIN}"

          echo "Checking ingress for ${APP_NAME} in namespace ${NAMESPACE}..."

          if $KUBECTL get ingress ${APP_NAME} -n ${NAMESPACE} 2>/dev/null; then
            echo "Ingress exists"
            $KUBECTL get ingress ${APP_NAME} -n ${NAMESPACE} -o yaml

            # Get the configured host
            INGRESS_HOST=$($KUBECTL get ingress ${APP_NAME} -n ${NAMESPACE} \
              -o jsonpath='{.spec.rules[0].host}')
            echo "Ingress host: ${INGRESS_HOST}"

            if [ "$INGRESS_HOST" != "$SUBDOMAIN" ]; then
              echo "WARNING: Ingress host (${INGRESS_HOST}) does not match expected subdomain (${SUBDOMAIN})"
            fi
          else
            echo "ERROR: Ingress not found. Run bootstrap-infra.yaml and ci-cd first."
            exit 1
          fi

      - name: Wait for Certificate
        run: |
          # Install kubectl locally (RULE 25)
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          KUBECTL="./kubectl"

          echo "Waiting for certificate to be issued..."

          MAX_ATTEMPTS=30
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            CERT_READY=$($KUBECTL get certificate ${APP_NAME}-${ENVIRONMENT}-tls -n ${NAMESPACE} \
              -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "NotFound")

            echo "[$ATTEMPT/$MAX_ATTEMPTS] Certificate status: ${CERT_READY}"

            if [ "$CERT_READY" = "True" ]; then
              echo "Certificate is ready!"
              break
            fi

            if [ "$CERT_READY" = "NotFound" ]; then
              echo "Certificate not found yet - cert-manager may still be processing"
            fi

            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ "$CERT_READY" != "True" ]; then
            echo "WARNING: Certificate not ready within timeout"
            echo "Checking certificate details..."
            $KUBECTL describe certificate ${APP_NAME}-${ENVIRONMENT}-tls -n ${NAMESPACE} 2>/dev/null || true
            $KUBECTL get certificaterequest -n ${NAMESPACE} 2>/dev/null || true
          fi

      - name: Verify HTTPS Endpoint
        run: |
          SUBDOMAIN="${TENANT}-${APP_NAME}-${ENVIRONMENT}.${DOMAIN}"
          HTTPS_URL="https://${SUBDOMAIN}"

          echo "Testing HTTPS endpoint: ${HTTPS_URL}"

          # Wait for DNS propagation
          sleep 30

          # Test HTTPS endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${HTTPS_URL}" -k --max-time 10 || echo "000")

          echo "HTTP Response Code: ${HTTP_CODE}"

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "HTTPS endpoint is accessible!"
          else
            echo "WARNING: HTTPS endpoint returned ${HTTP_CODE}"
            echo "This may be normal if DNS hasn't propagated yet"
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [setup-https]
    steps:
      - name: HTTPS Setup Summary
        run: |
          SUBDOMAIN="${TENANT}-${APP_NAME}-${ENVIRONMENT}.${DOMAIN}"

          echo "=============================================="
          echo "  HTTPS SETUP COMPLETE"
          echo "=============================================="
          echo "  Application:  ${APP_NAME}"
          echo "  Environment:  ${ENVIRONMENT}"
          echo "  URL:          https://${SUBDOMAIN}"
          echo "=============================================="
          echo ""
          echo "NOTE: Certificate may take 2-5 minutes to be fully issued."
          echo "If HTTPS is not working, wait a few minutes and try again."
          echo "=============================================="
