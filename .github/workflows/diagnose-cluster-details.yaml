# =============================================================================
# ğŸ¦ OPSERA DevOps Copilot - Deep Cluster Diagnostic
# Shows full details of cluster secrets including endpoints
# =============================================================================
name: "ğŸ”¬ Deep Cluster Diagnostic"

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'Cluster name to inspect'
        required: true
        default: 'opsera-usw2-np'
        type: string

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2

jobs:
  deep-diagnostic:
    name: "ğŸ”¬ Deep Cluster Analysis"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq

      - name: Connect to Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "âœ… Connected to ArgoCD hub cluster: ${{ env.HUB_CLUSTER }}"

      - name: Deep Cluster Analysis
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”¬ DEEP ARGOCD CLUSTER DIAGNOSTIC                                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          TARGET_CLUSTER="${{ inputs.cluster_name }}"
          
          echo "ğŸ¯ Target Cluster Name: ${TARGET_CLUSTER}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Get all cluster secrets
          SECRETS=$(kubectl get secrets -n argocd -l argocd.argoproj.io/secret-type=cluster -o json)
          
          # Count total clusters
          TOTAL=$(echo "$SECRETS" | jq '.items | length')
          echo "ğŸ“Š Total clusters registered in ArgoCD: ${TOTAL}"
          echo ""
          
          # Find matching clusters
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” SEARCHING FOR CLUSTERS NAMED: ${TARGET_CLUSTER}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          MATCH_COUNT=0
          
          echo "$SECRETS" | jq -r '.items[] | @base64' | while read secret; do
            # Decode the secret
            SECRET_NAME=$(echo "$secret" | base64 -d | jq -r '.metadata.name')
            CREATED=$(echo "$secret" | base64 -d | jq -r '.metadata.creationTimestamp')
            
            # Get and decode data fields
            CLUSTER_NAME_B64=$(echo "$secret" | base64 -d | jq -r '.data.name // empty')
            SERVER_B64=$(echo "$secret" | base64 -d | jq -r '.data.server // empty')
            
            if [ -n "$CLUSTER_NAME_B64" ]; then
              CLUSTER_NAME=$(echo "$CLUSTER_NAME_B64" | base64 -d 2>/dev/null || echo "decode-error")
              
              if [ "$CLUSTER_NAME" = "$TARGET_CLUSTER" ]; then
                MATCH_COUNT=$((MATCH_COUNT + 1))
                
                # Decode server URL
                if [ -n "$SERVER_B64" ]; then
                  SERVER_URL=$(echo "$SERVER_B64" | base64 -d 2>/dev/null || echo "decode-error")
                else
                  SERVER_URL="not-set"
                fi
                
                echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                echo "â”‚  ğŸ“¦ MATCH #${MATCH_COUNT}                                                        "
                echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
                echo "â”‚"
                echo "â”‚  ğŸ·ï¸  Secret Name:     ${SECRET_NAME}"
                echo "â”‚  ğŸ“›  Cluster Name:    ${CLUSTER_NAME}"
                echo "â”‚  ğŸŒ  Server Endpoint: ${SERVER_URL}"
                echo "â”‚  ğŸ“…  Created:         ${CREATED}"
                echo "â”‚"
                echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                echo ""
              fi
            fi
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ ANALYSIS COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Compare with Actual EKS Cluster
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”— COMPARING WITH ACTUAL EKS CLUSTER"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          TARGET_CLUSTER="${{ inputs.cluster_name }}"
          
          # Get actual EKS cluster endpoint
          echo "ğŸ“¡ Fetching actual EKS cluster endpoint for: ${TARGET_CLUSTER}"
          echo ""
          
          ACTUAL_ENDPOINT=$(aws eks describe-cluster --name "${TARGET_CLUSTER}" --region ${{ env.AWS_REGION }} --query 'cluster.endpoint' --output text 2>/dev/null || echo "NOT_FOUND")
          ACTUAL_STATUS=$(aws eks describe-cluster --name "${TARGET_CLUSTER}" --region ${{ env.AWS_REGION }} --query 'cluster.status' --output text 2>/dev/null || echo "NOT_FOUND")
          ACTUAL_VERSION=$(aws eks describe-cluster --name "${TARGET_CLUSTER}" --region ${{ env.AWS_REGION }} --query 'cluster.version' --output text 2>/dev/null || echo "NOT_FOUND")
          
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚  ğŸ¯ ACTUAL EKS CLUSTER: ${TARGET_CLUSTER}                                        "
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚"
          echo "â”‚  ğŸŒ  Endpoint:    ${ACTUAL_ENDPOINT}"
          echo "â”‚  ğŸ“Š  Status:      ${ACTUAL_STATUS}"
          echo "â”‚  ğŸ·ï¸   Version:     ${ACTUAL_VERSION}"
          echo "â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # Save for comparison
          echo "${ACTUAL_ENDPOINT}" > /tmp/actual_endpoint.txt

      - name: Recommendation
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ’¡ RECOMMENDATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          TARGET_CLUSTER="${{ inputs.cluster_name }}"
          ACTUAL_ENDPOINT=$(cat /tmp/actual_endpoint.txt)
          
          # Get cluster secrets again for comparison
          SECRETS=$(kubectl get secrets -n argocd -l argocd.argoproj.io/secret-type=cluster -o json)
          
          echo "Comparing ArgoCD secret endpoints with actual EKS endpoint..."
          echo ""
          
          VALID_SECRET=""
          INVALID_SECRETS=""
          
          echo "$SECRETS" | jq -r '.items[] | @base64' | while read secret; do
            SECRET_NAME=$(echo "$secret" | base64 -d | jq -r '.metadata.name')
            CLUSTER_NAME_B64=$(echo "$secret" | base64 -d | jq -r '.data.name // empty')
            SERVER_B64=$(echo "$secret" | base64 -d | jq -r '.data.server // empty')
            
            if [ -n "$CLUSTER_NAME_B64" ]; then
              CLUSTER_NAME=$(echo "$CLUSTER_NAME_B64" | base64 -d 2>/dev/null || echo "")
              
              if [ "$CLUSTER_NAME" = "$TARGET_CLUSTER" ]; then
                SERVER_URL=$(echo "$SERVER_B64" | base64 -d 2>/dev/null || echo "")
                
                if [ "$SERVER_URL" = "$ACTUAL_ENDPOINT" ]; then
                  echo "âœ… ${SECRET_NAME} â†’ VALID (endpoint matches EKS)"
                else
                  echo "âš ï¸  ${SECRET_NAME} â†’ STALE or DIFFERENT endpoint"
                  echo "    Secret endpoint:  ${SERVER_URL}"
                  echo "    Actual endpoint:  ${ACTUAL_ENDPOINT}"
                fi
              fi
            fi
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”§ NEXT STEPS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Based on the analysis above:"
          echo ""
          echo "1. If both secrets have the SAME endpoint â†’ They are true duplicates"
          echo "   â†’ Delete one using: kubectl delete secret <secret-name> -n argocd"
          echo ""
          echo "2. If secrets have DIFFERENT endpoints â†’ One may be stale"
          echo "   â†’ Keep the one matching the actual EKS endpoint"
          echo "   â†’ Delete the stale one"
          echo ""
          echo "3. To delete via GitHub Actions, run:"
          echo "   gh workflow run 'fix-duplicate-clusters.yaml' -f action=fix -f cluster_name=${TARGET_CLUSTER}"
          echo ""
